#!/usr/bin/env ruby
require 'shellwords'

# Convert epub file to mobi
class Epub2Mobi
  def initialize(*args)
    # Usage explanation if no args
    if args.empty?
      puts 'Usage :'
      puts '$ epub2mobi input.epub [input2.epub]'
      return
    end

    @input = args.reject do |file|
      next true if File.extname(file) != '.epub'
      next true unless File.exist?(file)
      false
    end
  end

  def run
    @input.each do |file|
      epub = File.expand_path(file)
      dirname = File.dirname(epub)
      extname = File.extname(epub)
      basename = File.basename(file, extname)
      mobi = File.join(dirname, basename + '.mobi')
      puts "Converting #{basename} to mobi"
      `ebook-convert #{epub.shellescape} #{mobi.shellescape}`
      `ebook-metadata-update #{mobi.shellescape}`
    end
  end
end
Epub2Mobi.new(*ARGV).run
