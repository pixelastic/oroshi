#!/usr/bin/env zsh
# Toggle between current window and a dedicated Claude Code window
# Each tab has its own Claude window stored in a "Claude" parking tab

local currentWindowId=$(kitty-window-id)
local originWindowId=$(kitty-window-get-var "$currentWindowId" "oroshi_claudeOriginWindowId")

# If we're in a Claude window, get back to the calling window
if [[ "$originWindowId" != "" ]]; then
  kitty-window-focus "$originWindowId"
  exit 0
fi

# From here, we assume we're in a normal window and want to go to Claude
local currentTabId=$(kitty-tab-id)
local claudeWindowName="claude-${currentTabId}"

# Create the claude tab if it doesn't yet exist
if ! kitty-tab-exists "claude"; then
  kitty-tab-create "claude"

  # Set the default window created with the tab as the claude window
  local newlyCreatedTabId=$(kitty-tab-id "claude")
  local firstWindow=$(kitty-window-list-raw --tab "$newlyCreatedTabId")
  local splitWindow=("${(@ps/â–®/)firstWindow}")
  local newlyCreatedWindowId="${splitWindow[1]}"
  kitty-window-set-var "$newlyCreatedWindowId" "oroshi_windowName" "$claudeWindowName"
fi

local claudeTabId=$(kitty-tab-id "claude")

# Create the Claude window if it doesn't yet exist
if ! kitty-window-exists "$claudeWindowName"; then
  kitty-window-create "$claudeWindowName" --tab "$claudeTabId"
fi

local claudeWindowId=$(kitty-window-id "$claudeWindowName")

# Focus the Claude window and make it fullscreen
kitty-window-focus "$claudeWindowId"
kitty-window-set-var "$claudeWindowId" "oroshi_claudeOriginWindowId" "$currentWindowId"
kitty-window-fullscreen-on "$claudeWindowId"
