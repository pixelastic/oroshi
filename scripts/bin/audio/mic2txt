#!/usr/bin/env zsh
# mic2text: Transcribe what is being said into text
# Greatly inspired by https://github.com/QuantiusBenignus/BlahST

local modelFile=~/local/etc/whisper.cpp/models/ggml-small.bin
local tmpFolder=/dev/shm/oroshi_speech-to-text
local pidFile=${tmpFolder}/PID
local recordFile=${tmpFolder}/record.wav

# Check if a recording is already running (so we can stop it), or not (so we can
# start it)
mkdir -p $tmpFolder;
local isRecordingRunning=0
[[ -f $pidFile ]] && isRecordingRunning=1


# RECORD {{{
# No recording running, starting one
if [[ $isRecordingRunning == "0" ]]; then
  rec \
    --rate 16000 \
    --channels 1 \
    $recordFile &

  # Save the pid
  echo $! > $pidFile
  exit 0
fi
# }}}

# TRANSCRIBE {{{
# A recording is already started, we stop it

# Add a 1s grace delay period
sleep 1

# Now, kill the recording
kill-pid "$(cat $pidFile)"

# We transcribe to text
local transcription="$(whisper-cli \
  --file $recordFile \
  --language fr \
  --threads 9 \
  --no-timestamps \
  --model $modelFile \
  2>/dev/null)"

# Clean it a bit
transcription="${transcription#*([[:space:]])}"
transcription="${(C)str:0:1}${transcription#?}"

# We paste it
notify-send "$transcription"

# We save the current clipboard
local currentClipboard="$(wl-paste)"

# Save the transcription in the Ctrl-C clipboard
echo $transcription | wl-copy
# Press Ctrl-V
export YDOTOOL_SOCKET=/home/tim/local/tmp/oroshi/ydotool/socket
ydotool key 29:1 47:1 47:0 29:0

# We revert the previous clipboard
echo $currentClipboard | wl-copy

# Also store the transcription in the middle click, in case we need it
echo $transcription | wl-copy -p

# Cleanup the pid file
rm $pidFile
# }}}
