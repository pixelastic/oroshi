#!/usr/bin/env zsh
set -e
# Create a new repository locally, and on GitHub, and install all deps
# Usage:
# $ git-directory-create-all ./npcs    # Creates pixelastic/npcs and ./npcs
# $ git-directory-create-all -a ./npcs # Creates algolia/npcs and ./npcs

# Parse args {{{
local originalArgs=("$@")

zparseopts -E -D a=flagAlgolia
local isAlgolia=${#flagAlgolia}

local repoName="${1:t}"
# }}}

# Create a new repo (pass all original arguments through)
git-directory-create "${originalArgs[@]}"

cd ./${repoName}

# Load nvm if needed
if [[ $OROSHI_NVM_LOADED == "0" ]]; then
  source ~/.nvm/nvm.sh
fi

# Use right node version
nvm use 22.18.0

# Init yarn
yarn-init

# Install aberlaas
yarn-dependency-add-dev aberlaas
yarn run aberlaas init

# Commit and push
git-commit-all "chore(init): Scaffolding"
# Sync with remote in case GitHub added default files
git-branch-rebase origin/main
git-branch-push

# Configure GitHub and CircleCi (Optional)
local additionalSetupArguments=""
[[ $isAlgolia == "1" ]] && additionalSetupArguments="--circleci=false --renovate=false"
yarn run aberlaas setup ${=additionalSetupArguments}

# Mark it for future jump
mark
