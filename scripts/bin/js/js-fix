#!/usr/bin/env zsh
# js-fix: Fix a JavaScript file
# Usage:
# $ js-fix ./path/to/file.js           # Output fixed code to stdout
# $ js-fix --in-place ./path/to/file.js # Overwrite the file
set -x

zparseopts -E -D \
  -in-place=flagInPlace
isInPlace=${#flagInPlace}

# Input file
inputFile="${1:a}"
if [[ ! -f "$inputFile" ]]; then
  echo "Error: File '$inputFile' not found" >&2
  exit 1
fi

# Project root
projectRoot=$(yarn-root ${inputFile:h} --force 2>/dev/null)

# Config file
configFile=~/.oroshi/eslint.config.js
if [[ $projectRoot != "" ]]; then
  [[ -f "$projectRoot/.eslintrc.js" ]] && configFile="$projectRoot/.eslintrc.js"
  [[ -f "$projectRoot/eslint.config.js" ]] && configFile="$projectRoot/eslint.config.js"
fi

# Output to stdout
if [[ $isInPlace = 0 ]]; then
  # shellcheck disable=SC2094
  eslint_d \
    --config "$configFile" \
    --fix-to-stdout \
    --stdin \
    --stdin-filename "$inputFile" \
    <"$inputFile"
  return
fi

# Update file in place
eslint_d \
  --fix \
  --config "$configFile" \
  "$inputFile"
