#!/usr/bin/env zsh
# js-fix: Fix a JavaScript file
# Usage:
# $ js-fix ./path/to/file.js                       # Output fixed code to stdout
# $ js-fix --in-place ./path/to/file.js            # Overwrite the file in place
# $ echo "code" | js-fix                           # Bad code form stdin, good code to stdout
# $ echo "code" | js-fix --filepath ./realpath.js  # We can be specific about where the code is located
zparseopts -E -D \
  -in-place=flagInPlace \
  -filepath:=flagFilepath
isInPlace=${#flagInPlace}
overrideFilepath=${flagFilepath[2]}

# Check if input is being piped
# Note: [[ -p /dev/stdin ]] doesn't seem to work with conform (nvim).
# This seem the most reliable way
hasStdin=0
[[ ! -t 0 ]] && hasStdin=1

# inputFilepath is the file to read
# realFilepath is where the file is located (for eslint rule resolution)
inputFilepath="${1:a}"
realFilepath="$inputFilepath"
[[ $overrideFilepath != "" ]] && realFilepath="$overrideFilepath"

# Config file (in project, or fallback to root)
projectRoot=$(yarn-root ${realFilepath:h} --force 2>/dev/null)
configFile=~/.oroshi/eslint.config.js
if [[ $projectRoot != "" ]]; then
  # Move to root, as this affects eslint resolution of plugins
  cd "$projectRoot" || exit 1

  [[ -f "$projectRoot/.eslintrc.js" ]] && configFile="$projectRoot/.eslintrc.js"
  [[ -f "$projectRoot/eslint.config.js" ]] && configFile="$projectRoot/eslint.config.js"
fi

# Input is stdin, output is stdout
# $ cat file.js | js-fix
# $ cat tmp.js | js-fix --filename ./realpath.js
if [[ $hasStdin = 1 ]]; then
  local stdinFile="${OROSHI_TMP_FOLDER}/js-fix/js-fix-$RANDOM"
  mkdir -p "${OROSHI_TMP_FOLDER}/js-fix"
  cat > $stdinFile

  # Additional arguments
  additionalArguments=()
  if [[ $realFilepath != "" ]]; then
    additionalArguments+=("--stdin-filename")
    additionalArguments+=("${realFilepath:a}")
  fi

  eslint_d \
    --config "$configFile" \
    --stdin \
    --fix-to-stdout \
    ${=additionalArguments} \
    <$stdinFile
  local exitCode=$?
  rm -f "$stdinFile"
  exit $exitCode
fi

# Input is a file, fix in place
# $ js-fix --in-place file.js
if [[ $isInPlace = 1 ]]; then
  eslint_d \
    --config "$configFile" \
    --fix \
    "$inputFilepath" 2>/dev/null
  exit $?
fi

# Input is a file, output the stdout
# $ js-fix file.js
eslint_d \
  --config "$configFile" \
  --stdin \
  --fix-to-stdout \
  --stdin-filename "$inputFilepath" \
  <$inputFilepath
