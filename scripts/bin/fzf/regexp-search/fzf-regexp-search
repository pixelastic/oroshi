#!/usr/bin/env zsh
# Starts a dynamic regexp search in file
# Usage:
# $ fzf-regexp-search fzf-regexp-search-***-source /path/to/directory

local sourceBinary="$1"
local directory="$2"

local gitRoot="$(git-directory-root -f)"

local rawSelection="$(\
  fzf \
      --disabled \
      --delimiter="   " \
      --with-nth=3 \
      --bind "change:reload:sleep 0.1; ${sourceBinary} {q} || true" \
)"

# We only need to keep the filepath from the selections
typeset -aU selection
local selection=()
for line in ${(f)rawSelection}; do
  local split=(${(@s/   /)line})
  local filepath="${directory}/$split[1]"
  # Skip selections that are not files (this can happen when selecting
  # a separator)
  [[ ! -r $filepath ]] && continue
  selection+=($filepath)
done

# Deduplicate elements
echo $selection
