#!/usr/bin/env zsh
# Commit with Claude-generated message
# Usage:
# $ git-commit-create-claude                 # Stage all and commit with Claude message
# $ git-commit-create-claude --dry-run       # Show generated message without committing
# $ git-commit-create-claude -n              # Skip git hooks
# $ git-commit-create-claude --force         # Commit without opening editor
function git-commit-create-claude() {
  # Parse arguments
  local dryRun=false
  local force=false
  local noVerify=false
  local extraArgs=()

  for arg in "$@"; do
    case "$arg" in
    --dry-run)
      dryRun=true
      ;;
    --force | -f)
      force=true
      ;;
    --no-verify | -n)
      noVerify=true
      extraArgs+=(--no-verify)
      ;;
    *)
      extraArgs+=("$arg")
      ;;
    esac
  done

  # Check if we're in a git repository
  if ! git rev-parse --git-dir >/dev/null 2>&1; then
    echo "Error: Not in a git repository" >&2
    return 1
  fi

  # Stage all files
  git add --all

  # Check if there are changes to commit
  if ! git diff --cached --quiet; then
    : # There are changes
  else
    echo "No changes to commit" >&2
    return 0
  fi

  # Create temporary file for Claude's response
  local tmpFile=$(mktemp /tmp/git-commit-claude-XXXXXX)
  trap "rm -f $tmpFile" EXIT

  # Call Claude Code to generate commit message
  echo "Generating commit message with Claude Code..." >&2

  # Use the git-commit-writer skill to generate the message
  # We use --print to get the output and redirect stderr to hide the interactive parts
  local claudeResponse=$(
    claude --print 2>/dev/null <<'EOF'
Use the git-commit-writer skill to analyze my staged changes and generate a commit message.

IMPORTANT:
- Return ONLY the commit message in Conventional Commits format
- Do NOT include any explanatory text, markdown formatting, or file lists
- Format: type(scope): description

  Body explaining the change in 1-3 sentences.
- If multiple logical concerns are detected, return only ONE message for the most significant change
- Be concise but informative

Output the commit message directly, ready to be used with git commit.
EOF
  )

  # Check if Claude Code succeeded
  if [[ $? -ne 0 ]] || [[ -z "$claudeResponse" ]]; then
    echo "Error: Failed to generate commit message with Claude Code" >&2
    echo "Make sure Claude Code is installed and configured" >&2
    return 1
  fi

  # Write the response to the temporary file
  echo "$claudeResponse" >"$tmpFile"

  # If dry-run, just show the message
  if [[ "$dryRun" == "true" ]]; then
    echo "Generated commit message:" >&2
    echo "" >&2
    cat "$tmpFile"
    return 0
  fi

  # If force mode, commit without opening editor
  if [[ "$force" == "true" ]]; then
    git commit --file="$tmpFile" --verbose ${extraArgs[@]}
    return $?
  fi

  # Open editor for user to review/modify the message
  git commit --edit --file="$tmpFile" --verbose ${extraArgs[@]}
  return $?
}
